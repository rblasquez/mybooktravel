"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};!function(t){"function"==typeof define&&define.amd?define(["jquery"],t):t("object"===("undefined"==typeof exports?"undefined":_typeof(exports))?require("jquery"):jQuery)}(function(t){function a(t){this.$container=t,this.$avatarView=this.$container.find(".avatar-view"),this.$avatar=this.$avatarView.find("img"),this.$avatarModal=this.$container.find("#avatar-modal"),this.$loading=this.$container.find(".loading"),this.$avatarForm=this.$avatarModal.find(".avatar-form"),this.$avatarUpload=this.$avatarForm.find(".avatar-upload"),this.$mensajes=this.$avatarForm.find(".avatar-mensajes"),this.$avatarSrc=this.$avatarForm.find(".avatar-src"),this.$avatarData=this.$avatarForm.find(".avatar-data"),this.$avatarInput=this.$avatarForm.find(".inputfile"),this.$avatarSave=this.$avatarForm.find(".avatar-save"),this.$avatarBtns=this.$avatarForm.find(".avatar-botones"),this.$avatarWrapper=this.$avatarModal.find(".avatar-wrapper"),this.$imageCanvas=this.$avatarModal.find("#miCanvas"),this.init()}t(function(){return new a(t("#crop-avatar"))});var i=window.console||{log:function(){}};a.prototype={constructor:a,support:{fileList:!!t('<input type="file">').prop("files"),blobURLs:!!window.URL&&URL.createObjectURL,formData:!!window.FormData},init:function(){this.support.datauri=this.support.fileList&&this.support.blobURLs,this.support.formData||this.initIframe(),this.initTooltip(),this.addListener()},addListener:function(){this.$avatarView.on("click",t.proxy(this.click,this)),this.$avatarInput.on("change",t.proxy(this.change,this)),this.$avatarForm.on("submit",t.proxy(this.submit,this)),this.$avatarBtns.on("click",t.proxy(this.rotate,this))},initTooltip:function(){this.$avatarView.tooltip({placement:"bottom"})},initPreview:function(){this.$avatar.attr("src")},initIframe:function(){var a="upload-iframe-"+(new Date).getTime(),r=t("<iframe>").attr({name:a,src:""}),e=this;r.one("load",function(){r.on("load",function(){var a;try{a=t(this).contents().find("body").text()}catch(t){i.log(t.message)}if(a){try{a=t.parseJSON(a)}catch(t){i.log(t.message)}e.submitDone(a)}else e.submitFail("Image upload failed!");e.submitEnd()})}),this.$iframe=r,this.$avatarForm.attr("target",a).after(r.hide())},click:function(){this.$avatarModal.modal("show"),this.initPreview()},change:function(){var t,a;this.$avatarSave.removeClass("hide"),this.support.datauri?(t=this.$avatarInput.prop("files"),t.length>0&&(a=t[0],this.isImageFile(a)&&(this.url&&URL.revokeObjectURL(this.url),this.url=URL.createObjectURL(a),this.startCropper()))):(a=this.$avatarInput.val(),this.isImageFile(a)&&this.syncUpload())},submit:function(){return!(!this.$avatarSrc.val()&&!this.$avatarInput.val())&&(this.support.formData?(this.ajaxUpload(),!1):void 0)},rotate:function(a){var i;this.active&&(i=t(a.target).data(),i.method&&this.$img.cropper(i.method,i.option))},isImageFile:function(t){return t.type?/^image\/\w+$/.test(t.type):/\.(jpg|jpeg|png)$/.test(t)},startCropper:function(){var a=this;this.active?this.$img.cropper("replace",this.url):(this.$img=t('<img src="'+this.url+'">'),this.$avatarWrapper.empty().html(this.$img),this.$img.cropper({aspectRatio:1,guides:!1,rotatable:!0,scalable:!0,zoomOnTouch:!1,viewMode:2,background:!1,checkOrientation:!0,responsive:!0,crop:function(i){var r=['{"x":'+i.x,'"y":'+i.y,'"height":'+i.height,'"width":'+i.width,'"rotate":'+i.rotate+"}"].join();t(this).cropper("getCroppedCanvas",{height:200});a.$avatarData.val(r)},ready:function(){}}),this.active=!0),this.$avatarModal.one("hidden.bs.modal",function(){a.stopCropper()})},stopCropper:function(){this.active&&(this.$img.cropper("destroy"),this.$img.remove(),this.active=!1)},ajaxUpload:function(){var a=this,i=this.$avatarForm.attr("action"),r=new FormData(this.$avatarForm[0]),e=this.$img.cropper("getCroppedCanvas",{height:200}),o=e.toDataURL("image/png");r.append("canvas",o);var a=this;t.ajax(i,{type:"post",data:r,dataType:"json",processData:!1,contentType:!1,beforeSend:function(){a.submitStart()},success:function(t){a.submitDone(t)},error:function(t,i,r){a.submitFail(i||r)},complete:function(){a.submitEnd()}})},syncUpload:function(){this.$avatarSave.click()},submitStart:function(){this.$loading.fadeIn()},submitDone:function(a){t("#userAvatar").attr("src",a),this.$avatarModal.modal("hide"),this.uploaded=!0,this.startCropper()},submitFail:function(t){this.alert(t)},submitEnd:function(){this.$loading.fadeOut()},cropDone:function(){this.$avatarForm.get(0).reset(),this.$avatar.attr("src",this.url),this.stopCropper(),this.$avatarModal.modal("hide")},alert:function(t){var a=['<div class="clearfix"></div>','<div class="alert alert-danger avatar-alert alert-dismissable">','<button type="button" class="close" data-dismiss="alert" style="width: auto;">&times;</button>',"Ha ocurrido un error en la carga de tu imagen, por favor intenta nuevamente.","</div>"].join("");this.$mensajes.html(a)}}});